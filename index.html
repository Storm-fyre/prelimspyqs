<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prelims Previous Years Questions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --muted-text: #6c757d;
      --accent-color: #007bff;
      --ok-color: #28a745;
      --bad-color: #dc3545;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --selection-color-dark: #0d47a1; /* Dark blue for selection outline */
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 16px;
      line-height: 1.6;
    }
    header {
      background: var(--card-bg);
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 2px 4px var(--shadow-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    .container {
      max-width: 960px;
      margin: 22px auto;
      padding: 0 16px 40px;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    .qid {
      color: var(--muted-text);
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .qtext {
      white-space: pre-wrap;
      font-size: 1.1em;
    }
    .opts {
      margin-top: 18px;
      display: grid;
      gap: 10px;
    }
    .opt {
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: all .2s ease-in-out;
    }
    .opt:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .opt.selected {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    .opt.correct {
      border-color: var(--ok-color);
      background: rgba(40, 167, 69, 0.1);
    }
    .opt.wrong {
      border-color: var(--bad-color);
      background: rgba(220, 53, 69, 0.1);
    }
    .qtext table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 14px;
    }
    .qtext th, .qtext td {
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      vertical-align: top;
    }
    .qtext th {
      background: #f8f9fa;
      text-align: left;
      font-weight: 600;
    }
    .meta {
      margin-top: 15px;
      color: var(--muted-text);
      font-size: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .explain {
      margin-top: 12px;
      display: none;
      border-left: 4px solid var(--accent-color);
      padding: 12px 14px;
      color: var(--text-color);
      background: #f8f9fa;
      border-radius: 8px;
      white-space: pre-wrap;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: baseline;
    }
    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 50px;
      color: var(--muted-text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .pill:hover:not(:disabled) {
        background-color: #e9ecef;
    }
    .pill:disabled {
        cursor: not-allowed;
        opacity: 0.65;
    }
    .filters-wrap {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 50px;
      border: 1px solid var(--border-color);
      background: #f8f9fa;
      cursor: pointer;
    }
    .chip input {
      accent-color: var(--accent-color);
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .hidden {
      display: none;
    }
    #resultsCard {
        text-align: center;
        border-top: 5px solid var(--accent-color);
    }
    .results-grid {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        gap: 15px;
        flex-wrap: wrap;
    }
    .result-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        flex-grow: 1;
        min-width: 120px;
    }
    .result-label {
        font-size: 14px;
        color: var(--muted-text);
        margin-bottom: 5px;
    }
    .result-value {
        font-size: 24px;
        font-weight: 600;
    }
    .result-value.correct { color: var(--ok-color); }
    .result-value.wrong { color: var(--bad-color); }
    .score-display {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }
    .score-fraction {
        font-size: 48px;
        font-weight: 700;
        color: var(--accent-color);
    }
    .total-marks {
        font-size: 24px;
        color: var(--muted-text);
        font-weight: 500;
    }
    .scaled-score {
        font-size: 18px;
        color: var(--muted-text);
        margin-top: 5px;
    }
    .quiz-submitted .opt.selected {
      box-shadow: 0 0 0 3px var(--selection-color-dark);
    }
    #noQuestionsModal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        padding: 25px 35px;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        z-index: 100;
        text-align: center;
        border-top: 4px solid var(--accent-color);
    }
    #noQuestionsModal p {
        margin: 0 0 15px;
        font-size: 1.1em;
    }
    #modalCloseBtn {
        position: absolute;
        top: 5px;
        right: 8px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted-text);
    }
    #quizInfo {
        font-size: 14px;
        color: var(--muted-text);
    }
    #quizInfo strong {
        color: var(--text-color);
    }
    #quizInfo .card {
        padding: 15px 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Prelims Previous Years Questions</h1>
    <div class="actions">
      <button id="submit" class="pill hidden">Submit</button>
      <button id="reset" class="pill hidden">Reset</button>
      <button id="quit" class="pill hidden">Quit Quiz</button>
    </div>
  </header>

  <div class="container">
    <div id="setup" class="card">
      <div class="toolbar">
        <div style="font-weight:600;">Filter Questions</div>
        <button id="clearFilters" class="pill">Clear Filters</button>
        <button id="refreshFiles" class="pill" style="margin-left:auto;">Refresh files</button>
      </div>

      <div id="selectors" style="margin-top:12px;">
        <div id="subjectPicker" class="card">
          <div class="toolbar">
            <div style="font-weight:600;">Choose subjects</div>
            <button class="pill toggle-all-btn hidden" data-target="subjects">Select All</button>
          </div>
          <div id="subjects" class="filters-wrap" style="margin-top:10px;"></div>
        </div>

        <div id="yearPicker" class="card">
          <div class="toolbar">
            <div style="font-weight:600;">Choose years</div>
            <button class="pill toggle-all-btn hidden" data-target="years">Select All</button>
          </div>
          <div id="years" class="filters-wrap" style="margin-top:10px;"></div>
        </div>

        <div id="difficultyPicker" class="card">
          <div class="toolbar">
            <div style="font-weight:600;">Choose difficulty</div>
            <button class="pill toggle-all-btn hidden" data-target="difficulties">Select All</button>
          </div>
          <div id="difficulties" class="filters-wrap" style="margin-top:10px;"></div>
        </div>
      </div>

      <div style="margin-top: 20px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
        <button id="start" class="pill" style="padding: 12px 28px; font-size: 1.1em; font-weight: 600; background-color: var(--accent-color); color: white; border-color: var(--accent-color);">Start Quiz</button>
      </div>
    </div>
    
    <div id="noQuestionsModal" class="hidden">
        <button id="modalCloseBtn">&times;</button>
        <p>No questions found.</p>
        <span class="small" style="font-size: 12px;">Please adjust your filters and try again.</span>
    </div>

    <div id="quizInfo" class="hidden"></div>
    
    <div id="resultsCard" class="card hidden">
        <h2>Quiz Results</h2>
        <div class="results-grid">
          <div class="result-item">
            <span class="result-label">Correct</span>
            <span id="correctCount" class="result-value correct">0</span>
          </div>
          <div class="result-item">
            <span class="result-label">Incorrect</span>
            <span id="incorrectCount" class="result-value wrong">0</span>
          </div>
          <div class="result-item">
            <span class="result-label">Unattempted</span>
            <span id="unattemptedCount" class="result-value">0</span>
          </div>
        </div>
        <div class="score-display">
          <h3>Your Score</h3>
          <div class="score-fraction">
            <span id="finalScore">0.00</span>
            <span class="total-marks">/ <span id="maxMarks">0</span></span>
          </div>
          <div class="scaled-score">
            (<span id="scaledScore">0.00</span> / 200)
          </div>
        </div>
      </div>

    <div id="out" class="hidden"></div>
  </div>

  <script>
    // App state
    const startBtn = document.getElementById('start');
    const submitBtn = document.getElementById('submit');
    const resetBtn = document.getElementById('reset');
    const quitBtn = document.getElementById('quit');
    const refreshBtn = document.getElementById('refreshFiles');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const yearsDiv = document.getElementById('years');
    const subjectsDiv = document.getElementById('subjects');
    const difficultiesDiv = document.getElementById('difficulties');
    const out = document.getElementById('out');
    const resultsCard = document.getElementById('resultsCard');
    const noQuestionsModal = document.getElementById('noQuestionsModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const quizInfoDiv = document.getElementById('quizInfo');

    let ALL_DATA = {};
    let currentQuestions = [];
    let userAnswers = {};
    let submitted = false;
    
    const DIFFICULTY_MAP = { 'E': 'Easy', 'M': 'Medium', 'H': 'Hard' };
    const DIFFICULTY_ORDER = ['E', 'M', 'H'];

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function renderMarkdownTablesPreservingLines(text) {
      const lines = (text || '').split('\n');
      const result = [];
      let i = 0;
      function isSeparator(line) {
        const parts = line.split('|').map(s => s.trim());
        if (parts.length < 2) return false;
        return parts.every(p => /^:?---+:?$/.test(p) || p === '');
      }
      function rowToCells(line, cellTag) {
        const parts = line.split('|');
        const cells = parts.map(s => s.trim());
        if (cells.length > 1 && cells[0] === '' && cells[cells.length-1] === '') { cells.shift(); cells.pop(); }
        return '<tr>' + cells.map(c => `<${cellTag}>${escapeHtml(c)}</${cellTag}>`).join('') + '</tr>';
      }
      while (i < lines.length) {
        const headerLine = lines[i];
        const sepLine = lines[i+1];
        if (headerLine && headerLine.includes('|') && sepLine && isSeparator(sepLine)) {
          let html = '<table><thead>';
          html += rowToCells(headerLine, 'th') + '</thead><tbody>';
          i += 2;
          while (i < lines.length && lines[i].includes('|') && !/^\s*$/.test(lines[i])) { html += rowToCells(lines[i], 'td'); i++; }
          html += '</tbody></table>';
          result.push(html);
          if (i < lines.length && /^\s*$/.test(lines[i])) { result.push(''); i++; }
        } else {
          result.push(escapeHtml(headerLine || ''));
          i++;
        }
      }
      return result.join('\n').replace(/(?<!>|\n)\n(?!<)/g, '<br>');
    }

    async function autoLoadAll() {
      ALL_DATA = {};
      let availableYears = new Set();
      let availableSubjects = [];
      let availableDifficulties = new Set();
      try {
        const res = await fetch('files.json', { cache: 'no-store' });
        if (res.ok) {
          const list = await res.json();
          if (Array.isArray(list) && list.length) {
            await Promise.all(list.map(async fname => { try { const r = await fetch(fname, {cache: 'no-store'}); if (r.ok) { ALL_DATA[fname] = await r.json(); availableSubjects.push(fname); } } catch(e){} }));
            finalizeLoad(availableSubjects, availableYears, availableDifficulties);
            return;
          }
        }
      } catch(e) {}
      try {
        const r = await fetch('polity.json', { cache: 'no-store' });
        if (r.ok) { ALL_DATA['polity.json'] = await r.json(); availableSubjects.push('polity.json'); finalizeLoad(availableSubjects, availableYears, availableDifficulties); return; }
      } catch(e) {}
      finalizeLoad(availableSubjects, availableYears, availableDifficulties);
    }

    function createChip(id, value, text) {
        const label = document.createElement('label');
        label.className = 'chip';
        label.htmlFor = id;
        label.innerHTML = `<input type="checkbox" id="${id}" value="${value}"> ${text}`;
        return label;
    }

    function finalizeLoad(availableSubjects, availableYears, availableDifficulties) {
      Object.keys(ALL_DATA).forEach(fname => {
        const data = ALL_DATA[fname];
        const years = data && data.years ? data.years : {};
        Object.keys(years).forEach(y => {
          availableYears.add(y);
          (years[y] || []).forEach(item => {
            if (item.difficulty) availableDifficulties.add(item.difficulty.toUpperCase());
          });
        });
      });

      subjectsDiv.innerHTML = '';
      availableSubjects.forEach(s => subjectsDiv.appendChild(createChip('s_' + s, s, s.replace(/\.json$/,''))));

      const yearsArr = Array.from(availableYears).sort((a,b)=>b.localeCompare(a));
      yearsDiv.innerHTML = '';
      yearsArr.forEach(y => yearsDiv.appendChild(createChip('y_' + y, y, y)));

      const diffsArr = Array.from(availableDifficulties);
      diffsArr.sort((a, b) => DIFFICULTY_ORDER.indexOf(a) - DIFFICULTY_ORDER.indexOf(b));
      
      difficultiesDiv.innerHTML = '';
      diffsArr.forEach(d_code => {
        const d_text = DIFFICULTY_MAP[d_code] || d_code;
        difficultiesDiv.appendChild(createChip('d_' + d_code, d_code, d_text));
      });
      
      setupFilterInteractions();
    }

    function getSelected(container) {
      return [...container.querySelectorAll('input[type="checkbox"]:checked')].map(i => i.value);
    }
    
    function getSelectedSubjects(){ return getSelected(subjectsDiv); }
    function getSelectedYears(){ return getSelected(yearsDiv); }
    function getSelectedDifficulties(){ return getSelected(difficultiesDiv); }

    function setupFilterInteractions() {
        document.querySelectorAll('.toggle-all-btn').forEach(button => {
            const targetId = button.dataset.target;
            const container = document.getElementById(targetId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            
            if (checkboxes.length > 1) button.classList.remove('hidden'); else button.classList.add('hidden');

            button.addEventListener('click', () => {
                const isSelectAll = button.textContent.includes('Select All');
                checkboxes.forEach(cb => cb.checked = isSelectAll);
                button.textContent = isSelectAll ? 'Unselect All' : 'Select All';
            });
        });
        
        clearFiltersBtn.addEventListener('click', () => {
            document.querySelectorAll('#selectors input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.toggle-all-btn').forEach(button => button.textContent = 'Select All');
        });
    }

    function getFilteredQuestions() {
        const selSubjects = getSelectedSubjects();
        const selYears = getSelectedYears();
        const selDifficulties = getSelectedDifficulties();
        const questions = [];
        const subjectKeys = selSubjects.length ? selSubjects : Object.keys(ALL_DATA);
        subjectKeys.forEach(fname => {
            const years = (ALL_DATA[fname] && ALL_DATA[fname].years) ? ALL_DATA[fname].years : {};
            const yearsToProcess = Object.keys(years);
            const chosenYears = selYears.length ? selYears : yearsToProcess;
            chosenYears.forEach(y => {
                (years[y] || []).forEach(item => {
                    const difficultyMatch = selDifficulties.length === 0 || (item.difficulty && selDifficulties.includes(item.difficulty.toUpperCase()));
                    if (difficultyMatch) questions.push(item);
                });
            });
        });
        return questions;
    }

    function renderQuiz() {
      out.innerHTML = '';
      userAnswers = {};
      submitted = false;
      currentQuestions.forEach((item, index) => appendQuestionCard(item, out, index + 1));
      submitBtn.classList.remove('hidden');
      resetBtn.classList.remove('hidden');
      quitBtn.classList.remove('hidden');
    }

    function appendQuestionCard(item, container, serialNumber){
      const card = document.createElement('div'); card.className = 'card';
      const qidDiv = document.createElement('div'); qidDiv.className = 'qid'; 
      qidDiv.textContent = `Question #${serialNumber}`;
      card.appendChild(qidDiv);
      const qtext = document.createElement('div'); qtext.className = 'qtext'; qtext.innerHTML = renderMarkdownTablesPreservingLines(item.question || '');
      card.appendChild(qtext);
      const optsWrap = document.createElement('div'); optsWrap.className = 'opts';
      (item.options || []).forEach((o) => {
        const opt = document.createElement('div'); opt.className = 'opt'; opt.textContent = o || ''; opt.dataset.qid = item.id;
        const key = ((o||'').trim().charAt(0) || '').toUpperCase(); opt.dataset.key = (['A','B','C','D'].includes(key) ? key : '');
        opt.addEventListener('click', () => onPick(item.id, opt, optsWrap)); optsWrap.appendChild(opt);
      });
      card.appendChild(optsWrap);
      const footer = document.createElement('div'); footer.className = 'meta';
      const ansShown = (item.answer || '').toString().trim().toUpperCase(); footer.dataset.answer = ansShown;
      const explainBtn = document.createElement('button'); explainBtn.className = 'pill hidden'; explainBtn.textContent = 'Explanation'; explainBtn.addEventListener('click', () => { expEl.style.display = (expEl.style.display === 'block' ? 'none' : 'block'); });
      const metaLabel = document.createElement('span'); metaLabel.className = 'hidden'; 
      const difficultyText = (item.difficulty && DIFFICULTY_MAP[item.difficulty.toUpperCase()]) ? DIFFICULTY_MAP[item.difficulty.toUpperCase()] : (item.difficulty || '—');
      metaLabel.textContent = `Answer: ${ansShown || '—'} · Difficulty: ${difficultyText}`;
      footer.appendChild(metaLabel); footer.appendChild(explainBtn); card.appendChild(footer);
      const expEl = document.createElement('div'); expEl.className = 'explain'; expEl.textContent = (item.explanation && item.explanation.trim()) ? item.explanation : 'No explanation provided.'; card.appendChild(expEl);
      container.appendChild(card);
    }

    // NEW: Updated onPick function to allow toggling/deselection
    function onPick(qid, optEl, optsWrap){
        if (submitted) return;
        const wasSelected = optEl.classList.contains('selected');
        [...optsWrap.children].forEach(c => c.classList.remove('selected')); // Clear all first
        
        if (wasSelected) {
            // It was selected, so now it's deselected. Remove the answer.
            if (qid) delete userAnswers[qid];
        } else {
            // It was not selected, so now we select it.
            optEl.classList.add('selected');
            const key = optEl.dataset.key;
            if (key && qid) userAnswers[qid] = key;
        }
    }

    function submitQuiz() {
      if (submitted) return;
      submitted = true;
      submitBtn.disabled = true;
      out.classList.add('quiz-submitted');

      let correct = 0;
      let incorrect = 0;
      const cards = out.querySelectorAll('.card');

      cards.forEach((card, index) => {
        const item = currentQuestions[index];
        const qid = item.id;
        const footer = card.querySelector('.meta');
        const answerKey = (footer?.dataset.answer || '').toUpperCase();
        const userAnswer = userAnswers[qid] || null;
        const options = card.querySelectorAll('.opt');
        
        const standardAnswers = ['A', 'B', 'C', 'D'];
        const isSpecialAnswer = !standardAnswers.includes(answerKey);

        if (isSpecialAnswer) {
            correct++; // NEW: Automatically correct, regardless of attempt
            options.forEach(opt => opt.classList.add('correct'));
        } else {
            options.forEach(opt => {
                const key = opt.dataset.key;
                const picked = userAnswer === key;
                if (answerKey && key === answerKey) opt.classList.add('correct');
                if (picked && key !== answerKey) opt.classList.add('wrong');
            });
            if (userAnswer) {
                if (userAnswer === answerKey) correct++; else incorrect++;
            }
        }
        
        const metaLabel = card.querySelector('.meta span');
        if (metaLabel) metaLabel.classList.remove('hidden');
        const explainBtn = card.querySelector('.pill');
        if (explainBtn) explainBtn.classList.remove('hidden');
      });

      const totalQuestions = cards.length;
      const unattempted = totalQuestions - correct - incorrect;
      const marks = (correct * 2) - (incorrect * (2 / 3));
      const maxMarks = totalQuestions * 2;
      const scaledScore = maxMarks > 0 ? (marks / maxMarks) * 200 : 0;

      document.getElementById('correctCount').textContent = correct;
      document.getElementById('incorrectCount').textContent = incorrect;
      document.getElementById('unattemptedCount').textContent = unattempted;
      document.getElementById('finalScore').textContent = marks.toFixed(2);
      document.getElementById('maxMarks').textContent = maxMarks;
      document.getElementById('scaledScore').textContent = scaledScore.toFixed(2);
      
      resultsCard.classList.remove('hidden');
      resultsCard.scrollIntoView({ behavior: 'smooth' });
    }

    function resetQuiz() {
      submitted = false;
      userAnswers = {};
      resultsCard.classList.add('hidden');
      submitBtn.disabled = false;
      out.classList.remove('quiz-submitted');
      renderQuiz();
    }

    function quitQuiz() {
      out.classList.add('hidden');
      quizInfoDiv.classList.add('hidden');
      document.getElementById('setup').classList.remove('hidden');
      submitBtn.classList.add('hidden');
      resetBtn.classList.add('hidden');
      quitBtn.classList.add('hidden');
      resultsCard.classList.add('hidden');
      submitBtn.disabled = false;
      out.classList.remove('quiz-submitted');
      currentQuestions = [];
    }

    startBtn.addEventListener('click', () => {
      currentQuestions = getFilteredQuestions();
      if (currentQuestions.length === 0) {
        noQuestionsModal.classList.remove('hidden');
        return;
      }

      const selSubjects = getSelectedSubjects();
      const selYears = getSelectedYears();
      const selDifficulties = getSelectedDifficulties();
      
      const subjectText = selSubjects.length ? selSubjects.map(s => s.replace(/\.json$/, '')).join(', ') : 'All';
      const yearText = selYears.length ? selYears.join(', ') : 'All';
      const diffText = selDifficulties.length ? selDifficulties.map(d => DIFFICULTY_MAP[d] || d).join(', ') : 'All';
      
      quizInfoDiv.innerHTML = `<div class="card"><strong>Subjects:</strong> ${subjectText} &nbsp;&nbsp;|&nbsp;&nbsp; <strong>Years:</strong> ${yearText} &nbsp;&nbsp;|&nbsp;&nbsp; <strong>Difficulty:</strong> ${diffText}</div>`;
      quizInfoDiv.classList.remove('hidden');

      document.getElementById('setup').classList.add('hidden');
      out.classList.remove('hidden');
      renderQuiz();
    });

    modalCloseBtn.addEventListener('click', () => noQuestionsModal.classList.add('hidden'));
    refreshBtn.addEventListener('click', autoLoadAll);
    submitBtn.addEventListener('click', submitQuiz);
    resetBtn.addEventListener('click', resetQuiz);
    quitBtn.addEventListener('click', quitQuiz);

    autoLoadAll();
  </script>
</body>
</html>